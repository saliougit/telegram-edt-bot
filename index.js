const TelegramBot = require('node-telegram-bot-api');
const cron = require('node-cron');
const express = require('express');

// ========================================
// üîê CONFIGURATION
// ========================================
// const TOKEN = '8280606106:AAGdeWR0Mh9pT-VbhESc0U4zU4i9T1RV4-Q';
const TOKEN = process.env.BOT_TOKEN || '8280606106:AAGdeWR0Mh9pT1U-VbhESc0U4zU4i9T1RV4';

const CHAT_ID = '982047637';

const bot = new TelegramBot(TOKEN, { polling: true });

// Express pour garder Glitch actif
const app = express();
app.get('/', (req, res) => res.send('Bot actif ! ‚úÖ'));
app.listen(3000);

// ========================================
// üìÖ EMPLOI DU TEMPS
// ========================================
const EDT = [
  {
    id: 1,
    nom: "üåÖ Routine matinale",
    description: "Exercice optionnel + Sangou + Dourous (Fawzayni + Djouki)",
    heureDebut: "05:00",
    heureFin: "07:00",
    emoji: "üåÖ"
  },
  {
    id: 2,
    nom: "üèÉ‚Äç‚ôÇÔ∏è Sport",
    description: "Course ou activit√© physique",
    heureDebut: "18:00",
    heureFin: "19:00",
    emoji: "üèÉ‚Äç‚ôÇÔ∏è"
  },
  {
    id: 3,
    nom: "üåô Sangoou + Dourous + Diang",
    description: "R√©vision, apprentissage Quran, √©criture ou r√©citation",
    heureDebut: "19:00",
    heureFin: "20:00",
    emoji: "üåô"
  },
  {
    id: 4,
    nom: "üìñ Sarr Al-Qur'an",
    description: "Lecture / m√©morisation selon progression",
    heureDebut: "20:00",
    heureFin: "21:00",
    emoji: "üìñ"
  },
  {
    id: 5,
    nom: "‚ú® Khassida",
    description: "√âtude des khassidas de la semaine",
    heureDebut: "21:00",
    heureFin: "22:00",
    emoji: "‚ú®"
  },
  {
    id: 6,
    nom: "üìö Cours CE2",
    description: "Cours √† l'enfant, max 22h30",
    heureDebut: "22:00",
    heureFin: "22:30",
    emoji: "üìö"
  },
  {
    id: 7,
    nom: "üíª Travail/T√¢ches",
    description: "T√¢ches ou repos selon planning",
    heureDebut: "22:30",
    heureFin: "23:00",
    emoji: "üíª"
  }
];

// ========================================
// üíæ SYST√àME DE SUIVI (stockage en m√©moire)
// ========================================
let statistiques = {
  activitesCompletes: {},
  activitesReportees: {},
  activitesAnnulees: {},
  derniereReinitialisation: new Date().toISOString().split('T')[0]
};

// R√©initialiser les stats chaque jour √† minuit
cron.schedule('0 0 * * *', () => {
  const aujourdhui = new Date().toISOString().split('T')[0];
  statistiques.activitesCompletes[aujourdhui] = [];
  statistiques.activitesReportees[aujourdhui] = [];
  statistiques.activitesAnnulees[aujourdhui] = [];
});

// Initialiser le jour actuel si n√©cessaire
function initialiserJour() {
  const aujourdhui = new Date().toISOString().split('T')[0];
  if (!statistiques.activitesCompletes[aujourdhui]) {
    statistiques.activitesCompletes[aujourdhui] = [];
  }
  if (!statistiques.activitesReportees[aujourdhui]) {
    statistiques.activitesReportees[aujourdhui] = [];
  }
  if (!statistiques.activitesAnnulees[aujourdhui]) {
    statistiques.activitesAnnulees[aujourdhui] = [];
  }
}

// ========================================
// üïí FONCTIONS UTILITAIRES
// ========================================
function heureEnMinutes(heure) {
  const [h, m] = heure.split(':').map(Number);
  return h * 60 + m;
}

function maintenant() {
  const now = new Date();
  return now.getHours() * 60 + now.getMinutes();
}

function activiteEnCours() {
  const now = maintenant();
  return EDT.find(a => {
    const debut = heureEnMinutes(a.heureDebut);
    const fin = heureEnMinutes(a.heureFin);
    return now >= debut && now < fin;
  });
}

function prochaineActivite() {
  const now = maintenant();
  return EDT.find(a => heureEnMinutes(a.heureDebut) > now);
}

function formaterEDT() {
  let message = "üìÖ *TON EMPLOI DU TEMPS* üìÖ\n\n";
  EDT.forEach((a) => {
    message += `${a.emoji} *${a.nom}*\n`;
    message += `   ‚è∞ ${a.heureDebut} - ${a.heureFin}\n`;
    message += `   üìù ${a.description}\n\n`;
  });
  return message;
}

// ========================================
// üìä FONCTIONS DE STATISTIQUES
// ========================================
function calculerStatsJour(jour) {
  const completes = statistiques.activitesCompletes[jour] || [];
  const reportees = statistiques.activitesReportees[jour] || [];
  const annulees = statistiques.activitesAnnulees[jour] || [];
  
  const total = EDT.length;
  const faites = completes.length;
  const pourcentage = total > 0 ? Math.round((faites / total) * 100) : 0;
  
  return { completes, reportees, annulees, total, faites, pourcentage };
}

function calculerStatsSemaine() {
  const aujourdhui = new Date();
  let totalCompletes = 0;
  let totalActivites = 0;
  const joursStats = [];
  
  for (let i = 6; i >= 0; i--) {
    const date = new Date(aujourdhui);
    date.setDate(date.getDate() - i);
    const dateStr = date.toISOString().split('T')[0];
    
    const stats = calculerStatsJour(dateStr);
    totalCompletes += stats.faites;
    totalActivites += stats.total;
    
    joursStats.push({
      date: dateStr,
      jour: date.toLocaleDateString('fr-FR', { weekday: 'short' }),
      ...stats
    });
  }
  
  const pourcentageSemaine = totalActivites > 0 
    ? Math.round((totalCompletes / totalActivites) * 100) 
    : 0;
  
  return { joursStats, totalCompletes, totalActivites, pourcentageSemaine };
}

function genererMessageStats() {
  const aujourdhui = new Date().toISOString().split('T')[0];
  const statsJour = calculerStatsJour(aujourdhui);
  const statsSemaine = calculerStatsSemaine();
  
  let message = "üìä *TES STATISTIQUES* üìä\n\n";
  
  // Stats du jour
  message += "üìÖ *Aujourd'hui :*\n";
  message += `‚úÖ ${statsJour.faites}/${statsJour.total} activit√©s compl√©t√©es (${statsJour.pourcentage}%)\n`;
  if (statsJour.reportees.length > 0) {
    message += `‚è≠Ô∏è ${statsJour.reportees.length} report√©e(s)\n`;
  }
  if (statsJour.annulees.length > 0) {
    message += `‚ùå ${statsJour.annulees.length} annul√©e(s)\n`;
  }
  
  // Barre de progression
  const barreComplete = Math.floor(statsJour.pourcentage / 10);
  const barreVide = 10 - barreComplete;
  message += `${"üü©".repeat(barreComplete)}${"‚¨ú".repeat(barreVide)} ${statsJour.pourcentage}%\n\n`;
  
  // Stats de la semaine
  message += "üìà *Cette semaine (7 derniers jours) :*\n";
  message += `‚úÖ ${statsSemaine.totalCompletes}/${statsSemaine.totalActivites} activit√©s (${statsSemaine.pourcentageSemaine}%)\n\n`;
  
  // D√©tail par jour
  message += "*D√©tail :*\n";
  statsSemaine.joursStats.forEach(j => {
    const emoji = j.pourcentage >= 80 ? "üî•" : j.pourcentage >= 50 ? "‚úÖ" : "üìä";
    message += `${emoji} ${j.jour} : ${j.faites}/${j.total} (${j.pourcentage}%)\n`;
  });
  
  // Motivation
  if (statsJour.pourcentage >= 80) {
    message += "\nüî• *Excellent travail !* Continue comme √ßa !";
  } else if (statsJour.pourcentage >= 50) {
    message += "\nüí™ *Bien jou√© !* Tu peux encore am√©liorer !";
  } else {
    message += "\nüå± *Chaque effort compte !* Bismillah pour la suite !";
  }
  
  return message;
}

// ========================================
// üîò BOUTONS INTERACTIFS
// ========================================
function creerBoutonsActivite(activiteId) {
  return {
    inline_keyboard: [
      [
        { text: '‚úÖ Fait', callback_data: `fait_${activiteId}` },
        { text: '‚è≠Ô∏è Reporter', callback_data: `reporter_${activiteId}` }
      ],
      [
        { text: '‚ùå Annuler', callback_data: `annuler_${activiteId}` }
      ]
    ]
  };
}

function creerBoutonsCommandes() {
  return {
    inline_keyboard: [
      [
        { text: 'üìÖ Programme', callback_data: 'cmd_programme' },
        { text: '‚è∞ Maintenant', callback_data: 'cmd_maintenant' }
      ],
      [
        { text: '‚û°Ô∏è Prochain', callback_data: 'cmd_prochain' },
        { text: 'üìä Stats', callback_data: 'cmd_stats' }
      ]
    ]
  };
}

// ========================================
// üì® GESTION DES CALLBACKS (BOUTONS)
// ========================================
bot.on('callback_query', (query) => {
  const chatId = query.message.chat.id;
  const messageId = query.message.message_id;
  const data = query.data;
  
  initialiserJour();
  const aujourdhui = new Date().toISOString().split('T')[0];
  
  // Actions sur les activit√©s
  if (data.startsWith('fait_')) {
    const activiteId = parseInt(data.split('_')[1]);
    const activite = EDT.find(a => a.id === activiteId);
    
    if (!statistiques.activitesCompletes[aujourdhui].includes(activiteId)) {
      statistiques.activitesCompletes[aujourdhui].push(activiteId);
    }
    
    const statsJour = calculerStatsJour(aujourdhui);
    bot.editMessageText(
      `‚úÖ *Activit√© valid√©e !*\n\n${activite.emoji} ${activite.nom}\n\nüìä Progression du jour : ${statsJour.faites}/${statsJour.total} (${statsJour.pourcentage}%)\n\nüí™ MashAllah, continue comme √ßa !`,
      {
        chat_id: chatId,
        message_id: messageId,
        parse_mode: 'Markdown'
      }
    );
    
    bot.answerCallbackQuery(query.id, { text: '‚úÖ Activit√© compl√©t√©e !' });
  }
  
  else if (data.startsWith('reporter_')) {
    const activiteId = parseInt(data.split('_')[1]);
    const activite = EDT.find(a => a.id === activiteId);
    
    if (!statistiques.activitesReportees[aujourdhui].includes(activiteId)) {
      statistiques.activitesReportees[aujourdhui].push(activiteId);
    }
    
    bot.editMessageText(
      `‚è≠Ô∏è *Activit√© report√©e*\n\n${activite.emoji} ${activite.nom}\n\nPas de probl√®me ! Tu pourras la faire plus tard insha'Allah.`,
      {
        chat_id: chatId,
        message_id: messageId,
        parse_mode: 'Markdown'
      }
    );
    
    bot.answerCallbackQuery(query.id, { text: '‚è≠Ô∏è Activit√© report√©e' });
  }
  
  else if (data.startsWith('annuler_')) {
    const activiteId = parseInt(data.split('_')[1]);
    const activite = EDT.find(a => a.id === activiteId);
    
    if (!statistiques.activitesAnnulees[aujourdhui].includes(activiteId)) {
      statistiques.activitesAnnulees[aujourdhui].push(activiteId);
    }
    
    bot.editMessageText(
      `‚ùå *Activit√© annul√©e*\n\n${activite.emoji} ${activite.nom}\n\nC'est not√©. On reprend demain insha'Allah !`,
      {
        chat_id: chatId,
        message_id: messageId,
        parse_mode: 'Markdown'
      }
    );
    
    bot.answerCallbackQuery(query.id, { text: '‚ùå Activit√© annul√©e' });
  }
  
  // Commandes rapides
  else if (data === 'cmd_programme') {
    bot.sendMessage(chatId, formaterEDT(), { parse_mode: 'Markdown' });
    bot.answerCallbackQuery(query.id);
  }
  
  else if (data === 'cmd_maintenant') {
    const activite = activiteEnCours();
    if (activite) {
      bot.sendMessage(
        chatId,
        `‚è≥ *EN CE MOMENT :*\n\n${activite.emoji} ${activite.nom}\n‚è∞ ${activite.heureDebut} - ${activite.heureFin}\nüìù ${activite.description}`,
        { parse_mode: 'Markdown' }
      );
    } else {
      bot.sendMessage(chatId, "üåô Aucune activit√© pr√©vue maintenant.");
    }
    bot.answerCallbackQuery(query.id);
  }
  
  else if (data === 'cmd_prochain') {
    const prochaine = prochaineActivite();
    if (prochaine) {
      bot.sendMessage(
        chatId,
        `‚û°Ô∏è *PROCHAINE ACTIVIT√â :*\n\n${prochaine.emoji} ${prochaine.nom}\n‚è∞ ${prochaine.heureDebut}\nüìù ${prochaine.description}`,
        { parse_mode: 'Markdown' }
      );
    } else {
      bot.sendMessage(chatId, "üåô Plus d'activit√©s pr√©vues aujourd'hui.");
    }
    bot.answerCallbackQuery(query.id);
  }
  
  else if (data === 'cmd_stats') {
    bot.sendMessage(chatId, genererMessageStats(), { parse_mode: 'Markdown' });
    bot.answerCallbackQuery(query.id);
  }
});

// ========================================
// üé® NOTIFICATIONS PERSONNALIS√âES
// ========================================

// URLs d'images/GIFs pour chaque activit√© (exemples)
const MEDIA = {
  sport: 'https://media.giphy.com/media/3o7TKF1fSIs1R19B8k/giphy.gif',
  quran: 'https://example.com/quran-beautiful.jpg',
  khassida: 'https://example.com/islamic-calligraphy.jpg',
  motivation: 'https://media.giphy.com/media/26FPy3QZQqGtDcrja/giphy.gif'
};

// Messages motivants vari√©s
const MESSAGES_MOTIVATION = [
  "üí™ Qu'Allah facilite !",
  "üî• Tu es sur la bonne voie !",
  "‚ú® Chaque effort compte !",
  "üåü Bismillah, courage !",
  "üíé La constance m√®ne au succ√®s !"
];

function getMessageMotivation() {
  return MESSAGES_MOTIVATION[Math.floor(Math.random() * MESSAGES_MOTIVATION.length)];
}

// Fonction d'√©moji selon l'heure
function getEmojiHeure() {
  const heure = new Date().getHours();
  if (heure < 6) return 'üåô';
  if (heure < 12) return '‚òÄÔ∏è';
  if (heure < 18) return 'üå§Ô∏è';
  return 'üåÜ';
}

// ========================================
// NOTIFICATION 10 MINUTES AVANT (Am√©lior√©e)
// ========================================
EDT.forEach(activite => {
  const [h, m] = activite.heureDebut.split(':').map(Number);
  const minutesAvant = m - 10;
  const heureAvant = minutesAvant < 0 ? h - 1 : h;
  const minAvant = minutesAvant < 0 ? 60 + minutesAvant : minutesAvant;
  
  cron.schedule(`${minAvant} ${heureAvant} * * *`, () => {
    initialiserJour();
    const aujourdhui = new Date().toISOString().split('T')[0];
    const stats = calculerStatsJour(aujourdhui);
    
    const message = `
${getEmojiHeure()} *PR√âPARATION - DANS 10 MINUTES*

${activite.emoji} *${activite.nom}*
üìù ${activite.description}

üìä Progression du jour : ${stats.faites}/${stats.total}
${"üü©".repeat(stats.faites)}${"‚¨ú".repeat(stats.total - stats.faites)}

üîî Pr√©pare-toi ! ${getMessageMotivation()}
    `.trim();
    
    bot.sendMessage(CHAT_ID, message, { parse_mode: 'Markdown' });
  });
  
  // ========================================
  // NOTIFICATION AU D√âBUT (Avec image/GIF selon l'activit√©)
  // ========================================
  cron.schedule(`${m} ${h} * * *`, () => {
    initialiserJour();
    const aujourdhui = new Date().toISOString().split('T')[0];
    const stats = calculerStatsJour(aujourdhui);
    
    const caption = `
‚ö°‚ö°‚ö° *C'EST L'HEURE !* ‚ö°‚ö°‚ö°

${activite.emoji} *${activite.nom}*
‚è∞ ${activite.heureDebut} - ${activite.heureFin}

üìä ${stats.faites}/${stats.total} aujourd'hui
${stats.pourcentage >= 70 ? 'üî•' : stats.pourcentage >= 50 ? 'üí™' : 'üå±'} ${stats.pourcentage}% compl√©t√©es

‚ú® Bismillah, c'est parti !
    `.trim();
    
    // Envoyer avec GIF pour le sport
    if (activite.id === 2) { // Sport
      bot.sendAnimation(CHAT_ID, MEDIA.sport, {
        caption: caption,
        parse_mode: 'Markdown',
        reply_markup: creerBoutonsActivite(activite.id)
      });
    }
    // Envoyer avec image pour les activit√©s spirituelles
    else if ([3, 4, 5].includes(activite.id)) { // Diang, Sarr, Khassida
      // Si tu veux une image, d√©commente la ligne suivante
      // bot.sendPhoto(CHAT_ID, MEDIA.quran, { ... });
      
      // Sinon, message simple avec beaucoup d'√©mojis
      bot.sendMessage(CHAT_ID, caption, {
        parse_mode: 'Markdown',
        reply_markup: creerBoutonsActivite(activite.id)
      });
    }
    // Message simple pour les autres
    else {
      bot.sendMessage(CHAT_ID, caption, {
        parse_mode: 'Markdown',
        reply_markup: creerBoutonsActivite(activite.id)
      });
    }
  });
  
  // ========================================
  // NOTIFICATION √Ä LA FIN (Avec encouragement)
  // ========================================
  const [hFin, mFin] = activite.heureFin.split(':').map(Number);
  cron.schedule(`${mFin} ${hFin} * * *`, () => {
    initialiserJour();
    const aujourdhui = new Date().toISOString().split('T')[0];
    const stats = calculerStatsJour(aujourdhui);
    const prochaine = prochaineActivite();
    
    // Message diff√©rent si l'activit√© a √©t√© valid√©e ou non
    const estValidee = stats.completes.includes(activite.id);
    
    let message = estValidee 
      ? `‚úÖ *BRAVO !*\n\n${activite.emoji} ${activite.nom} termin√© !\n\n`
      : `‚è±Ô∏è *TEMPS √âCOUL√â*\n\n${activite.emoji} ${activite.nom}\n\n`;
    
    if (prochaine) {
      message += `‚û°Ô∏è *Prochaine activit√© :*\n${prochaine.emoji} ${prochaine.nom}\n‚è∞ Dans ${calculerTempsAvant(prochaine)} min`;
    } else {
      message += `üåô C'√©tait la derni√®re activit√©.\n\nüìä Tape /stats pour ton bilan !`;
    }
    
    // Ajouter stats de la journ√©e
    message += `\n\nüìä Bilan du jour : ${stats.faites}/${stats.total} (${stats.pourcentage}%)`;
    
    if (stats.pourcentage >= 80) {
      message += '\n\nüî• *Excellent travail !* MashAllah !';
    } else if (stats.pourcentage >= 50) {
      message += '\n\nüí™ *Bien jou√© !* Continue !';
    }
    
    bot.sendMessage(CHAT_ID, message, {
      parse_mode: 'Markdown',
      reply_markup: estValidee ? creerBoutonsCommandes() : creerBoutonsActivite(activite.id)
    });
  });
});

// Fonction helper pour calculer le temps avant une activit√©
function calculerTempsAvant(activite) {
  const now = maintenant();
  const debut = heureEnMinutes(activite.heureDebut);
  return debut - now;
}

// ========================================
// NOTIFICATION SP√âCIALE : Milieu de journ√©e
// ========================================
cron.schedule('0 13 * * *', () => {
  initialiserJour();
  const aujourdhui = new Date().toISOString().split('T')[0];
  const stats = calculerStatsJour(aujourdhui);
  
  if (stats.faites === 0) {
    bot.sendMessage(CHAT_ID, 
      `üå§Ô∏è *Petit rappel de midi*\n\nTu n'as pas encore valid√© d'activit√©s aujourd'hui.\n\nüí™ Ce n'est pas grave ! La journ√©e n'est pas finie.\n\n‚ú® ${getMessageMotivation()}`,
      { parse_mode: 'Markdown', reply_markup: creerBoutonsCommandes() }
    );
  } else if (stats.pourcentage >= 80) {
    bot.sendMessage(CHAT_ID, 
      `üî• *Tu cartonne aujourd'hui !*\n\n${stats.faites}/${stats.total} activit√©s valid√©es (${stats.pourcentage}%)\n\nüåü Continue comme √ßa !`,
      { parse_mode: 'Markdown' }
    );
  }
});

// ========================================
// NOTIFICATION : Encouragement du soir (22h)
// ========================================
cron.schedule('0 22 * * *', () => {
  initialiserJour();
  const aujourdhui = new Date().toISOString().split('T')[0];
  const stats = calculerStatsJour(aujourdhui);
  
  let message = 'üåô *Bonsoir Saliou*\n\n';
  
  if (stats.pourcentage >= 80) {
    message += `üî• *Journ√©e exceptionnelle !*\n\n${stats.faites}/${stats.total} activit√©s compl√©t√©es\n\nüèÜ Tu es un champion ! Qu'Allah te r√©compense !`;
  } else if (stats.pourcentage >= 50) {
    message += `üí™ *Belle journ√©e !*\n\n${stats.faites}/${stats.total} activit√©s compl√©t√©es\n\n‚ú® Continue comme √ßa demain insha'Allah !`;
  } else {
    message += `üå± *Chaque effort compte*\n\n${stats.faites}/${stats.total} activit√©s aujourd'hui\n\nüíé Demain sera meilleur insha'Allah !\n\nLa constance est la cl√©.`;
  }
  
  message += '\n\nüìä Tape /stats pour voir le d√©tail complet';
  
  bot.sendMessage(CHAT_ID, message, { 
    parse_mode: 'Markdown',
    reply_markup: creerBoutonsCommandes()
  });
});
// ========================================
// ‚è∞ NOTIFICATIONS PROGRAMM√âES
// ========================================

// R√©sum√© du matin √† 5h00
cron.schedule('0 5 * * *', () => {
  initialiserJour();
  const message = `‚òÄÔ∏è *BONJOUR SALIOU !* ‚òÄÔ∏è\n\n${formaterEDT()}\nüí™ Bonne journ√©e remplie de baraka !`;
  bot.sendMessage(CHAT_ID, message, { 
    parse_mode: 'Markdown',
    reply_markup: creerBoutonsCommandes()
  });
});

// Bilan du soir √† 23h
cron.schedule('0 23 * * *', () => {
  bot.sendMessage(CHAT_ID, genererMessageStats(), { 
    parse_mode: 'Markdown'
  });
});

// Pour chaque activit√©
EDT.forEach(activite => {
  const [h, m] = activite.heureDebut.split(':').map(Number);
  
  // 10 minutes avant
  const minutesAvant = m - 10;
  const heureAvant = minutesAvant < 0 ? h - 1 : h;
  const minAvant = minutesAvant < 0 ? 60 + minutesAvant : minutesAvant;
  
  cron.schedule(`${minAvant} ${heureAvant} * * *`, () => {
    bot.sendMessage(
      CHAT_ID,
      `‚è∞ *DANS 10 MINUTES*\n\n${activite.emoji} ${activite.nom}\nüìù ${activite.description}\n\nüîî Pr√©pare-toi !`,
      { parse_mode: 'Markdown' }
    );
  });
  
  // Au d√©but
  cron.schedule(`${m} ${h} * * *`, () => {
    bot.sendMessage(
      CHAT_ID,
      `‚ñ∂Ô∏è *C'EST L'HEURE !*\n\n${activite.emoji} ${activite.nom}\nüìù ${activite.description}\n\n‚ú® Bismillah, c'est parti !`,
      { 
        parse_mode: 'Markdown',
        reply_markup: creerBoutonsActivite(activite.id)
      }
    );
  });
  
  // √Ä la fin
  const [hFin, mFin] = activite.heureFin.split(':').map(Number);
  cron.schedule(`${mFin} ${hFin} * * *`, () => {
    const prochaine = prochaineActivite();
    let message = `‚è±Ô∏è *TEMPS √âCOUL√â*\n\n${activite.emoji} ${activite.nom}\n\n`;
    
    if (prochaine) {
      message += `‚û°Ô∏è *Prochaine :* ${prochaine.emoji} ${prochaine.nom}\n‚è∞ √Ä ${prochaine.heureDebut}`;
    } else {
      message += `üåô C'√©tait la derni√®re activit√©.\n\nTape /stats pour voir ton bilan !`;
    }
    
    bot.sendMessage(CHAT_ID, message, {
      parse_mode: 'Markdown',
      reply_markup: creerBoutonsActivite(activite.id)
    });
  });
});

// ========================================
// ü§ñ COMMANDES DU BOT
// ========================================

bot.onText(/\/start/, (msg) => {
  const message = `ÿßŸÑÿ≥ŸÑÿßŸÖ ÿπŸÑŸäŸÉŸÖ *Saliou* ! üëã

Je suis ton assistant personnel avec suivi et statistiques !

üîî *Notifications automatiques :*
‚Ä¢ 5h00 : R√©sum√© du jour
‚Ä¢ 10 min avant : Pr√©paration
‚Ä¢ Au d√©but : "C'est l'heure !" + boutons
‚Ä¢ √Ä la fin : Temps √©coul√© + boutons
‚Ä¢ 23h00 : Bilan statistique

üìä *Suivi d'activit√©s :*
Clique sur les boutons pour valider, reporter ou annuler !

üí™ Qu'Allah facilite ton chemin !`;
  
  bot.sendMessage(msg.chat.id, message, { 
    parse_mode: 'Markdown',
    reply_markup: creerBoutonsCommandes()
  });
});

bot.onText(/\/programme/, (msg) => {
  bot.sendMessage(msg.chat.id, formaterEDT(), { parse_mode: 'Markdown' });
});

bot.onText(/\/maintenant/, (msg) => {
  const activite = activiteEnCours();
  if (activite) {
    bot.sendMessage(
      msg.chat.id,
      `‚è≥ *EN CE MOMENT :*\n\n${activite.emoji} ${activite.nom}\n‚è∞ ${activite.heureDebut} - ${activite.heureFin}\nüìù ${activite.description}`,
      { parse_mode: 'Markdown' }
    );
  } else {
    bot.sendMessage(msg.chat.id, "üåô Aucune activit√© pr√©vue maintenant.");
  }
});

bot.onText(/\/prochain/, (msg) => {
  const prochaine = prochaineActivite();
  if (prochaine) {
    bot.sendMessage(
      msg.chat.id,
      `‚û°Ô∏è *PROCHAINE ACTIVIT√â :*\n\n${prochaine.emoji} ${prochaine.nom}\n‚è∞ ${prochaine.heureDebut}\nüìù ${prochaine.description}`,
      { parse_mode: 'Markdown' }
    );
  } else {
    bot.sendMessage(msg.chat.id, "üåô Plus d'activit√©s pr√©vues aujourd'hui.");
  }
});

bot.onText(/\/stats/, (msg) => {
  bot.sendMessage(msg.chat.id, genererMessageStats(), { parse_mode: 'Markdown' });
});

bot.onText(/\/menu/, (msg) => {
  bot.sendMessage(msg.chat.id, "üéØ *MENU RAPIDE*", {
    parse_mode: 'Markdown',
    reply_markup: creerBoutonsCommandes()
  });
});

// ========================================
// üöÄ D√âMARRAGE
// ========================================
console.log('ü§ñ Bot d√©marr√© avec succ√®s !');
console.log(`üì± Chat ID : ${CHAT_ID}`);
console.log('‚è∞ Notifications actives');
console.log('üìä Syst√®me de suivi actif');
console.log('‚úÖ En attente...');

bot.sendMessage(CHAT_ID, '‚úÖ *Bot red√©marr√© !*\n\nüìä Syst√®me de suivi activ√©\nüîò Boutons interactifs pr√™ts\n\nüöÄ Je suis pr√™t !', { 
  parse_mode: 'Markdown',
  reply_markup: creerBoutonsCommandes()

});
